{"pageProps":{"post":{"title":"react v18, nextjs, react-query 엣지 케이스","date":"2021-12-11T00:00:00.000Z","tags":["react","react-query","suspense","nextjs"],"draft":false,"summary":"react 18과 react-query의 suspense mode를 nextjs환경에서 사용하면서 겪었던 엣지 케이스에 대해서 정리했습니다.","body":{"raw":"\nnextjs, react@next, react-dom@next, react-query의 suspense mode를 같이 사용하면서 다음 이슈를 겪었습니다.\n\n1. server에서 page 컴포넌트를 render할 때에 react-query useQuery의 queryFunction이 실행됨.\n\n- 원래 react-query의 useQuery는 useEffect안에서 queryFunction을 실행시키기때문에 browser환경에서만 실행되어야하는데 (react-query의 suspense 옵션을 enabled하면) suspense for data fetching의 특성상 브라우저나 서버와 같은 환경과 상관없이 render와 동시에 queryFunction이 실행되기 때문에 위와 같은 상황이 발생합니다.\n- 그런데 page 컴포넌트의 useQuery는 jwt가 필요한 api를 부르는 hook이었고 server request에 접근할 수 없기 때문에 cookie에 접근할 수 없고 jwt를 얻을 수 없기 때문에 무조건 error를 낼 수 밖에 없었습니다. 그래서 useQuery가 서버에서는 실행이 안되었으면 했는데요. 또, server에서 미리 해당 queryKey의 data를 prefetch하기 때문에 실제로 client에서 page가 render될 때에는 데이터가 있을 건데, 서버에서 불필요하게 useQuery의 queryFunction을 실행시키는 것을 막고 싶었습니다.\n\n2. 그래서 제가 땜빵(?)으로 취한 접근은 아래와 같이 useQuery를 server에서는 성공한 것처럼 if문을 추가했습니다.\n\n```\nfunction useMyQuery(queryKey, queryFn) {\n  return useQuery(queryKey, async () => {\n    if (typeof window === 'undefined') {\n      return {};\n    }\n\n    const result = await queryFn();\n    return result;\n  }\n};\n```\n\n3. 그런데 이 접근이 뭔가 마음에 들지 않아서 [react-query repository discussion](https://github.com/tannerlinsley/react-query/discussions/3030)에 올려서 contributor들에게 의견을 구해봤는데요.\n4. 답변으로 아직 React 18이 공식적으로 나오진 않았고 react-query가 이 부분에 대한 대응을 아직 하지 않은 상황이라는 대답만 얻었습니다. 그래서 지금은 우선 제가 한 방법이 어떻게든 작동하게 할 수 있게 하는 방법으로 생각하고 유지해야 될 것 같다는 결론에 도달했습니다.\n\n이렇게 구구절절 적은 이유는 react-query에 대해서 조금 더 알게 된 부분(queryFunction이 어떻게 실행되는지 그리고 suspense option이 true일 때 어떻게 실행되는지와 같은 내용)을 공유하고 싶었고,\ndiscussion에서 짧은 논의였지만 contributor들과 대화를 나누는 경험이 재밌었고, contributors들이 이 기능은 나중에 React 18이 정식으로 나오면 ssr환경에서 react-query 차원에서 지원이 되어야할 케이스인 것 같다고\n친절하게 답변해준 점도 흥미로워서 겸사겸사 노트를 남겨 보았습니다.\n","code":"var Component=(()=>{var l=Object.create;var t=Object.defineProperty;var o=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var y=Object.getPrototypeOf,p=Object.prototype.hasOwnProperty;var a=n=>t(n,\"__esModule\",{value:!0});var h=(n,s)=>()=>(s||n((s={exports:{}}).exports,s),s.exports),m=(n,s)=>{a(n);for(var c in s)t(n,c,{get:s[c],enumerable:!0})},q=(n,s,c)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let r of d(s))!p.call(n,r)&&r!==\"default\"&&t(n,r,{get:()=>s[r],enumerable:!(c=o(s,r))||c.enumerable});return n},f=n=>q(a(t(n!=null?l(y(n)):{},\"default\",n&&n.__esModule&&\"default\"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var u=h((b,i)=>{i.exports=_jsx_runtime});var N={};m(N,{default:()=>g,frontmatter:()=>x});var e=f(u()),x={title:\"react v18, nextjs, react-query \\uC5E3\\uC9C0 \\uCF00\\uC774\\uC2A4\",date:\"2021-12-11\",tags:[\"react\",\"react-query\",\"suspense\",\"nextjs\"],draft:!1,summary:\"react 18\\uACFC react-query\\uC758 suspense mode\\uB97C nextjs\\uD658\\uACBD\\uC5D0\\uC11C \\uC0AC\\uC6A9\\uD558\\uBA74\\uC11C \\uACAA\\uC5C8\\uB358 \\uC5E3\\uC9C0 \\uCF00\\uC774\\uC2A4\\uC5D0 \\uB300\\uD574\\uC11C \\uC815\\uB9AC\\uD588\\uC2B5\\uB2C8\\uB2E4.\"};function j(n={}){let{wrapper:s}=n.components||{};return s?(0,e.jsx)(s,Object.assign({},n,{children:(0,e.jsx)(c,{})})):c();function c(){let r=Object.assign({p:\"p\",ol:\"ol\",li:\"li\",ul:\"ul\",pre:\"pre\",code:\"code\",span:\"span\",a:\"a\"},n.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(r.p,{children:\"nextjs, react@next, react-dom@next, react-query\\uC758 suspense mode\\uB97C \\uAC19\\uC774 \\uC0AC\\uC6A9\\uD558\\uBA74\\uC11C \\uB2E4\\uC74C \\uC774\\uC288\\uB97C \\uACAA\\uC5C8\\uC2B5\\uB2C8\\uB2E4.\"}),(0,e.jsx)(r.ol,{children:(0,e.jsx)(r.li,{children:\"server\\uC5D0\\uC11C page \\uCEF4\\uD3EC\\uB10C\\uD2B8\\uB97C render\\uD560 \\uB54C\\uC5D0 react-query useQuery\\uC758 queryFunction\\uC774 \\uC2E4\\uD589\\uB428.\"})}),(0,e.jsxs)(r.ul,{children:[(0,e.jsx)(r.li,{children:\"\\uC6D0\\uB798 react-query\\uC758 useQuery\\uB294 useEffect\\uC548\\uC5D0\\uC11C queryFunction\\uC744 \\uC2E4\\uD589\\uC2DC\\uD0A4\\uAE30\\uB54C\\uBB38\\uC5D0 browser\\uD658\\uACBD\\uC5D0\\uC11C\\uB9CC \\uC2E4\\uD589\\uB418\\uC5B4\\uC57C\\uD558\\uB294\\uB370 (react-query\\uC758 suspense \\uC635\\uC158\\uC744 enabled\\uD558\\uBA74) suspense for data fetching\\uC758 \\uD2B9\\uC131\\uC0C1 \\uBE0C\\uB77C\\uC6B0\\uC800\\uB098 \\uC11C\\uBC84\\uC640 \\uAC19\\uC740 \\uD658\\uACBD\\uACFC \\uC0C1\\uAD00\\uC5C6\\uC774 render\\uC640 \\uB3D9\\uC2DC\\uC5D0 queryFunction\\uC774 \\uC2E4\\uD589\\uB418\\uAE30 \\uB54C\\uBB38\\uC5D0 \\uC704\\uC640 \\uAC19\\uC740 \\uC0C1\\uD669\\uC774 \\uBC1C\\uC0DD\\uD569\\uB2C8\\uB2E4.\"}),(0,e.jsx)(r.li,{children:\"\\uADF8\\uB7F0\\uB370 page \\uCEF4\\uD3EC\\uB10C\\uD2B8\\uC758 useQuery\\uB294 jwt\\uAC00 \\uD544\\uC694\\uD55C api\\uB97C \\uBD80\\uB974\\uB294 hook\\uC774\\uC5C8\\uACE0 server request\\uC5D0 \\uC811\\uADFC\\uD560 \\uC218 \\uC5C6\\uAE30 \\uB54C\\uBB38\\uC5D0 cookie\\uC5D0 \\uC811\\uADFC\\uD560 \\uC218 \\uC5C6\\uACE0 jwt\\uB97C \\uC5BB\\uC744 \\uC218 \\uC5C6\\uAE30 \\uB54C\\uBB38\\uC5D0 \\uBB34\\uC870\\uAC74 error\\uB97C \\uB0BC \\uC218 \\uBC16\\uC5D0 \\uC5C6\\uC5C8\\uC2B5\\uB2C8\\uB2E4. \\uADF8\\uB798\\uC11C useQuery\\uAC00 \\uC11C\\uBC84\\uC5D0\\uC11C\\uB294 \\uC2E4\\uD589\\uC774 \\uC548\\uB418\\uC5C8\\uC73C\\uBA74 \\uD588\\uB294\\uB370\\uC694. \\uB610, server\\uC5D0\\uC11C \\uBBF8\\uB9AC \\uD574\\uB2F9 queryKey\\uC758 data\\uB97C prefetch\\uD558\\uAE30 \\uB54C\\uBB38\\uC5D0 \\uC2E4\\uC81C\\uB85C client\\uC5D0\\uC11C page\\uAC00 render\\uB420 \\uB54C\\uC5D0\\uB294 \\uB370\\uC774\\uD130\\uAC00 \\uC788\\uC744 \\uAC74\\uB370, \\uC11C\\uBC84\\uC5D0\\uC11C \\uBD88\\uD544\\uC694\\uD558\\uAC8C useQuery\\uC758 queryFunction\\uC744 \\uC2E4\\uD589\\uC2DC\\uD0A4\\uB294 \\uAC83\\uC744 \\uB9C9\\uACE0 \\uC2F6\\uC5C8\\uC2B5\\uB2C8\\uB2E4.\"})]}),(0,e.jsx)(r.ol,{start:\"2\",children:(0,e.jsx)(r.li,{children:\"\\uADF8\\uB798\\uC11C \\uC81C\\uAC00 \\uB55C\\uBE75(?)\\uC73C\\uB85C \\uCDE8\\uD55C \\uC811\\uADFC\\uC740 \\uC544\\uB798\\uC640 \\uAC19\\uC774 useQuery\\uB97C server\\uC5D0\\uC11C\\uB294 \\uC131\\uACF5\\uD55C \\uAC83\\uCC98\\uB7FC if\\uBB38\\uC744 \\uCD94\\uAC00\\uD588\\uC2B5\\uB2C8\\uB2E4.\"})}),(0,e.jsx)(r.pre,{children:(0,e.jsxs)(r.code,{className:\"code-highlight\",children:[(0,e.jsx)(r.span,{className:\"code-line\",children:`function useMyQuery(queryKey, queryFn) {\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`  return useQuery(queryKey, async () => {\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`    if (typeof window === 'undefined') {\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`      return {};\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`    }\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`    const result = await queryFn();\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`    return result;\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`  }\n`}),(0,e.jsx)(r.span,{className:\"code-line\",children:`};\n`})]})}),(0,e.jsxs)(r.ol,{start:\"3\",children:[(0,e.jsxs)(r.li,{children:[\"\\uADF8\\uB7F0\\uB370 \\uC774 \\uC811\\uADFC\\uC774 \\uBB54\\uAC00 \\uB9C8\\uC74C\\uC5D0 \\uB4E4\\uC9C0 \\uC54A\\uC544\\uC11C \",(0,e.jsx)(r.a,{href:\"https://github.com/tannerlinsley/react-query/discussions/3030\",children:\"react-query repository discussion\"}),\"\\uC5D0 \\uC62C\\uB824\\uC11C contributor\\uB4E4\\uC5D0\\uAC8C \\uC758\\uACAC\\uC744 \\uAD6C\\uD574\\uBD24\\uB294\\uB370\\uC694.\"]}),(0,e.jsx)(r.li,{children:\"\\uB2F5\\uBCC0\\uC73C\\uB85C \\uC544\\uC9C1 React 18\\uC774 \\uACF5\\uC2DD\\uC801\\uC73C\\uB85C \\uB098\\uC624\\uC9C4 \\uC54A\\uC558\\uACE0 react-query\\uAC00 \\uC774 \\uBD80\\uBD84\\uC5D0 \\uB300\\uD55C \\uB300\\uC751\\uC744 \\uC544\\uC9C1 \\uD558\\uC9C0 \\uC54A\\uC740 \\uC0C1\\uD669\\uC774\\uB77C\\uB294 \\uB300\\uB2F5\\uB9CC \\uC5BB\\uC5C8\\uC2B5\\uB2C8\\uB2E4. \\uADF8\\uB798\\uC11C \\uC9C0\\uAE08\\uC740 \\uC6B0\\uC120 \\uC81C\\uAC00 \\uD55C \\uBC29\\uBC95\\uC774 \\uC5B4\\uB5BB\\uAC8C\\uB4E0 \\uC791\\uB3D9\\uD558\\uAC8C \\uD560 \\uC218 \\uC788\\uAC8C \\uD558\\uB294 \\uBC29\\uBC95\\uC73C\\uB85C \\uC0DD\\uAC01\\uD558\\uACE0 \\uC720\\uC9C0\\uD574\\uC57C \\uB420 \\uAC83 \\uAC19\\uB2E4\\uB294 \\uACB0\\uB860\\uC5D0 \\uB3C4\\uB2EC\\uD588\\uC2B5\\uB2C8\\uB2E4.\"})]}),(0,e.jsx)(r.p,{children:\"\\uC774\\uB807\\uAC8C \\uAD6C\\uAD6C\\uC808\\uC808 \\uC801\\uC740 \\uC774\\uC720\\uB294 react-query\\uC5D0 \\uB300\\uD574\\uC11C \\uC870\\uAE08 \\uB354 \\uC54C\\uAC8C \\uB41C \\uBD80\\uBD84(queryFunction\\uC774 \\uC5B4\\uB5BB\\uAC8C \\uC2E4\\uD589\\uB418\\uB294\\uC9C0 \\uADF8\\uB9AC\\uACE0 suspense option\\uC774 true\\uC77C \\uB54C \\uC5B4\\uB5BB\\uAC8C \\uC2E4\\uD589\\uB418\\uB294\\uC9C0\\uC640 \\uAC19\\uC740 \\uB0B4\\uC6A9)\\uC744 \\uACF5\\uC720\\uD558\\uACE0 \\uC2F6\\uC5C8\\uACE0, discussion\\uC5D0\\uC11C \\uC9E7\\uC740 \\uB17C\\uC758\\uC600\\uC9C0\\uB9CC contributor\\uB4E4\\uACFC \\uB300\\uD654\\uB97C \\uB098\\uB204\\uB294 \\uACBD\\uD5D8\\uC774 \\uC7AC\\uBC0C\\uC5C8\\uACE0, contributors\\uB4E4\\uC774 \\uC774 \\uAE30\\uB2A5\\uC740 \\uB098\\uC911\\uC5D0 React 18\\uC774 \\uC815\\uC2DD\\uC73C\\uB85C \\uB098\\uC624\\uBA74 ssr\\uD658\\uACBD\\uC5D0\\uC11C react-query \\uCC28\\uC6D0\\uC5D0\\uC11C \\uC9C0\\uC6D0\\uC774 \\uB418\\uC5B4\\uC57C\\uD560 \\uCF00\\uC774\\uC2A4\\uC778 \\uAC83 \\uAC19\\uB2E4\\uACE0 \\uCE5C\\uC808\\uD558\\uAC8C \\uB2F5\\uBCC0\\uD574\\uC900 \\uC810\\uB3C4 \\uD765\\uBBF8\\uB85C\\uC6CC\\uC11C \\uACB8\\uC0AC\\uACB8\\uC0AC \\uB178\\uD2B8\\uB97C \\uB0A8\\uACA8 \\uBCF4\\uC558\\uC2B5\\uB2C8\\uB2E4.\"})]})}}var g=j;return N;})();\n;return Component;"},"_id":"blog/react-query-ssr.mdx","_raw":{"sourceFilePath":"blog/react-query-ssr.mdx","sourceFileName":"react-query-ssr.mdx","sourceFileDir":"blog","contentType":"mdx","flattenedPath":"blog/react-query-ssr"},"type":"Blog","readingTime":{"text":"2 min read","minutes":1.34,"time":80400,"words":268},"slug":"react-query-ssr","toc":[]},"authorDetails":[{"name":"Seonghyeon Kim","avatar":"/static/images/avatar.png","occupation":"Product Engineer","company":"Korea credit data","email":"impressor7@gmail.com","twitter":"https://twitter.com/seonghyeon___","linkedin":"https://www.linkedin.com/in/seonghyeon-kim-328757b7/","github":"https://github.com/seonghyeonkimm","type":"Authors","readingTime":{"text":"6 min read","minutes":5.19,"time":311400,"words":1038},"slug":"default","toc":[{"value":"Introduction","url":"#introduction","depth":2},{"value":"Experiences","url":"#experiences","depth":2},{"value":"한국신용데이터","url":"#한국신용데이터","depth":3},{"value":"MMP(Marketing Management Platform) 사내 공용 라이브러리","url":"#mmpmarketing-management-platform-사내-공용-라이브러리","depth":4},{"value":"캐시노트마켓","url":"#캐시노트마켓","depth":4},{"value":"캐시노트마켓 파트너센터","url":"#캐시노트마켓-파트너센터","depth":4},{"value":"캐시노트 신용점수조회","url":"#캐시노트-신용점수조회","depth":4},{"value":"캐시노트 2.0","url":"#캐시노트-20","depth":4},{"value":"티페이","url":"#티페이","depth":3},{"value":"가맹점 관리/계약 어드민","url":"#가맹점-관리계약-어드민","depth":4},{"value":"스타일쉐어","url":"#스타일쉐어","depth":3},{"value":"인앱 검색 서비스","url":"#인앱-검색-서비스","depth":4},{"value":"웹 스토어 리뉴얼","url":"#웹-스토어-리뉴얼","depth":4},{"value":"아파트멘터리","url":"#아파트멘터리","depth":3},{"value":"랜딩페이지","url":"#랜딩페이지","depth":4},{"value":"시공 및 커머스를 위한 백오피스","url":"#시공-및-커머스를-위한-백오피스","depth":4},{"value":"상품 정보 크롤링 크롬 익스텐션","url":"#상품-정보-크롤링-크롬-익스텐션","depth":4},{"value":"인테리어 상품 커머스","url":"#인테리어-상품-커머스","depth":4},{"value":"스포카","url":"#스포카","depth":3},{"value":"전사 데이터 대시보드 구성","url":"#전사-데이터-대시보드-구성","depth":4},{"value":"계약서비스 개발","url":"#계약서비스-개발","depth":4},{"value":"데이터 추출을 위한 쿼리 작성","url":"#데이터-추출을-위한-쿼리-작성","depth":4},{"value":"Communities","url":"#communities","depth":2},{"value":"Presentations","url":"#presentations","depth":3},{"value":"Lecture","url":"#lecture","depth":3},{"value":"Education","url":"#education","depth":2},{"value":"경희대학교","url":"#경희대학교","depth":3}]}],"prev":{"title":"2020년 반이 지나간 자리","date":"2020-07-05T00:00:00.000Z","tags":["retrospection"],"draft":false,"summary":"2020년 반이 지나간 자리에 어떤 것이 남아 있는가","type":"Blog","readingTime":{"text":"5 min read","minutes":4.525,"time":271500,"words":905},"slug":"2020-self-retrospection","toc":[{"value":"느끼고 기록하고 나누는 삶을 지향하자","url":"#느끼고-기록하고-나누는-삶을-지향하자","depth":2},{"value":"유용한 가치 구축을 통한 자본에 종속되지 않는 삶","url":"#유용한-가치-구축을-통한-자본에-종속되지-않는-삶","depth":2}]},"next":{"title":"nextjs 서비스 개발부터 운영까지 (1) - nextjs 서비스 아키텍처","date":"2021-12-18T00:00:00.000Z","tags":["nextjs"],"draft":false,"summary":"nextjs로 지금 현재 커머스를 개발하고 있습니다. 그런데 어쩌다보니 많은 부분에 있어서 직접 셋업하는 과정에 참여했고, 그 과정에서 배웠던 내용들을 팀원들에게 공유하고자 다음 글을 기획했습니다.","type":"Blog","readingTime":{"text":"11 min read","minutes":10.16,"time":609600,"words":2032},"slug":"nextjs-develop-and-operation-1","toc":[{"value":"Part 1 - nextjs 서비스 아키텍처","url":"#part-1---nextjs-서비스-아키텍처","depth":1},{"value":"목차","url":"#목차","depth":2},{"value":"nextjs는 무엇에 쓰는 물건인가?","url":"#nextjs는-무엇에-쓰는-물건인가","depth":2},{"value":"nextjs 서비스 아키텍처","url":"#nextjs-서비스-아키텍처","depth":2},{"value":"1. ECR(Elastic Container Registry) 구성하기","url":"#1-ecrelastic-container-registry-구성하기","depth":3},{"value":"2. ECS(Elastic Container Service)로 서버 띄우기","url":"#2-ecselastic-container-service로-서버-띄우기","depth":3},{"value":"3. ALB(application Load Balancer)","url":"#3-albapplication-load-balancer","depth":3},{"value":"4. CloudFront(CDN)","url":"#4-cloudfrontcdn","depth":3},{"value":"5. Route53, ACM(AWS Certificate Manager)","url":"#5-route53-acmaws-certificate-manager","depth":3},{"value":"nextjs 서비스 배포하기","url":"#nextjs-서비스-배포하기","depth":2},{"value":"nextjs 서비스 모니터링하기","url":"#nextjs-서비스-모니터링하기","depth":2},{"value":"nextjs 서비스 아키텍처 구성 중 트러블슈팅","url":"#nextjs-서비스-아키텍처-구성-중-트러블슈팅","depth":2},{"value":"회사 내부의 네트워크에 대한 이해","url":"#회사-내부의-네트워크에-대한-이해","depth":3},{"value":"cloudfront origin, behavior에 대한 이해","url":"#cloudfront-origin-behavior에-대한-이해","depth":3},{"value":"마무리","url":"#마무리","depth":2}]}},"__N_SSG":true}